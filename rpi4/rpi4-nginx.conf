user pi;
worker_processes auto;
pid /run/nginx.pid;

events {
  worker_connections  32768;
  worker_aio_requests 128;
  multi_accept        off;
  use                 epoll;
}

worker_rlimit_nofile 65536;
worker_priority -1;
worker_cpu_affinity auto;
thread_pool default threads=64 max_queue=65536;

http {
	include /etc/nginx/mime.types;
	gzip on;
	gzip_vary on;
	gzip_disable "MSIE [1-6]\.";
	gzip_proxied any;
	gzip_http_version 1.1;
	gzip_min_length 1024;
	gzip_comp_level  9;
 	gzip_buffers 128 8k;
	gzip_types application/atom+xml application/javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/svg+xml image/x-icon text/css text/plain text/x-component;
	ignore_invalid_headers on;
	reset_timedout_connection on;
	send_timeout 60;
	connection_pool_size 4096;
	server_tokens off;
	ssl_session_timeout 1h;
	upstream api {
		zone api 1024k;
		#least_conn;
		keepalive 4096;
		server raspberrypi5:8010 max_fails=3 fail_timeout=3s;
    		server raspberrypi6:8010 max_fails=3 fail_timeout=3s;
		server raspberrypi3:8010 max_fails=3 fail_timeout=3s;
		server raspberrypi2:8010 max_fails=3 fail_timeout=3s;
	}
	upstream hdr {
		zone hdr 1024k;
		keepalive 128;
		server localhost:8012;
	}
	server {
		listen 8011 backlog=1024;
		if ($scheme != "http") {
			rewrite ^ http://$host$uri permanent;
		}
		location /nginx_status {
			keepalive_requests 1024;
			sendfile on;
			tcp_nodelay on;
			tcp_nopush on;
			stub_status on;
		}
		#location /status {
     		#	status;
		#}
    		#location = /status.html {
    		#}
	}
	server {
		listen 8010 ssl http2 backlog=1024;
		include snippets/self-signed.conf;
    		include snippets/ssl-params.conf;
		http2_max_concurrent_streams 1024;
		server_name giancarlobonansea.homeip.net raspberrypi4 localhost;
		if ($scheme != "https") {
    			rewrite ^ https://$host$uri permanent;
		}
		location /node/ {
			return 301 https://giancarlobonansea.homeip.net:33333/;
		}
               	location / {
                        root /home/pi/clusterednode-client;
                        index index.html;
                        sendfile on;
			tcp_nodelay on;
			tcp_nopush on;
                }
    		location /api {
			keepalive_requests 65536;
			keepalive_timeout 120s;
                        sendfile on;
			tcp_nodelay on;
			tcp_nopush on;
			proxy_http_version 1.1;
			proxy_buffering off;
			proxy_buffer_size 128k;
			proxy_buffers 2048 128k;
			proxy_no_cache $http_pragma $http_authorization $http_nocache;
			proxy_set_header Cache-Control "no-cache, nocache, no-cache";
			proxy_set_header Pragma "no-cache, no-cache, no-cache";
			proxy_set_header Host $host;
    			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Forwarded-Scheme $scheme;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Host $proxy_host;
			proxy_set_header X-Forwarded-Port $proxy_port;
			add_header X-nginX-Time $request_time;
			proxy_next_upstream error timeout invalid_header http_500;
			proxy_connect_timeout 60s;
			proxy_ignore_client_abort on;
        		proxy_pass https://api;
    		}
                location /hdr {
                        sendfile on;
                        tcp_nodelay on;
                        tcp_nopush on;
                        proxy_http_version 1.1;
                        proxy_buffering off;
                        proxy_buffer_size 128k;
                        proxy_buffers 2048 128k;
                        proxy_no_cache $http_pragma $http_authorization $http_nocache;
                        proxy_set_header Cache-Control "no-cache, nocache, no-cache";
                        proxy_set_header Pragma "no-cache, no-cache, no-cache";
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_set_header X-Forwarded-Scheme $scheme;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Host $proxy_host;
                        proxy_set_header X-Forwarded-Port $proxy_port;
                        proxy_next_upstream error timeout invalid_header http_500;
                        proxy_connect_timeout 60s;
			proxy_ignore_client_abort on;
                        proxy_pass https://hdr;
                }
	}
	#log_format upstream_time '$remote_addr [$time_iso8601] ($connection,$connection_requests,$request_time,$status,$body_bytes_sent) "$request" "$http_user_agent"';
	#access_log /var/log/nginx/access.log upstream_time buffer=128k off;
        access_log off;
	error_log /var/log/nginx/error.log error;
}
